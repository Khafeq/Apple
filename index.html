<!doctypehtml><html lang=ar><meta charset=utf-8><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"name=viewport><meta content="no-cache, no-store, must-revalidate"http-equiv=Cache-Control><meta content=no-cache http-equiv=Pragma><meta content=0 http-equiv=Expires><title>AppelBoom v3.0 - Designed by Khaled Albadawi (khaledalbadawi.a@gmail.com)</title><style>:root{--slot-font:30px;--slot-gap:12px}*{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial}body,html{height:100%;margin:0;padding:0;background:#222}.wrap{width:100%;height:100vh;display:flex;align-items:center;justify-content:center;padding:12px}.stage{width:100%;max-width:1320px;height:calc(100vh - 24px);position:relative;border-radius:8px;overflow:hidden;background-color:#000}.bg{position:absolute;inset:0;z-index:0;background-size:cover;background-position:center center;filter:none}header{position:fixed;top:0;left:0;width:100%;height:100%;z-index:9999;pointer-events:none}header .title{position:absolute;bottom:10px;left:50%;transform:translateX(calc(-50% + 30px));font-weight:800;color:#fff;z-index:10000;padding:12px 24px;background:rgba(0,0,0,.7);border-radius:8px;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.2);pointer-events:auto}header .controls{position:absolute;bottom:30px;right:120px;z-index:10000;display:flex;gap:8px;align-items:center;padding:0;background:0 0!important;border:none!important;pointer-events:auto}.sound-toggle{padding:10px;border-radius:50%;background:rgba(255,255,255,.9);border:none;cursor:pointer;width:44px;height:44px;display:flex;align-items:center;justify-content:center;font-size:0;position:relative;z-index:10001}.sound-toggle::before{content:"üîä";font-size:22px;pointer-events:none}.sound-toggle.muted::before{content:"üîá"}.timer-container{position:fixed;top:20px;right:20px;left:auto;transform:none;background:rgba(199,55,55,.9);color:#fff;padding:12px 20px;border-radius:25px;font-size:20px;font-weight:900;z-index:10000;display:none;border:2px solid #f44;box-shadow:0 4px 12px rgba(0,0,0,.3);min-width:80px;text-align:center}.timer-container.warning{background:rgba(255,68,68,.95);border-color:red;animation:pulse .8s infinite}@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.08)}100%{transform:scale(1)}}.timer-container.visible{display:block}.page{display:none;height:calc(100% - 64px);position:relative;z-index:5;padding:12px}.page.active{display:block}.lang-col{display:flex;flex-direction:column;gap:10px;margin-top:500px;pointer-events:auto;position:relative;z-index:1000}.setup{height:100%;display:grid;grid-template-columns:88px 1fr;gap:12px;align-items:start}.lang-btn{width:72px;height:38px;border-radius:8px;background:rgba(255,255,255,.92);display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:800;border:2px solid transparent;transition:all .3s ease}.lang-btn:hover{border-color:#0b5138;transform:scale(1.05)}.lang-btn.active{background:#0b5138;color:#fff;border-color:#0b5138}.tree-wrap{position:relative;width:100%;height:100%;display:flex;align-items:center;justify-content:center;z-index:1}.tree-frame{width:90%!important;max-width:740px!important;aspect-ratio:4/3;position:relative;display:flex;align-items:center;justify-content:center;margin-left:-750px;margin-top:65px}.tree-img{position:absolute;left:45%!important;top:50%;transform:translate(-50%,-50%);width:100%;height:135%;object-fit:cover;border-radius:8px}.hero-apples,.tree-apples{position:absolute;left:7%;top:8%;width:86%;height:84%;pointer-events:none}.apple-item{position:absolute;transform:translate(-50%,-50%);display:flex;align-items:center;justify-content:center}.apple-item img{display:block;max-width:100%;height:auto;pointer-events:none}.input-container{position:absolute;right:20px;top:120px;width:680px!important;z-index:10}.input-field{width:100%;border:none;padding:16px 20px!important;border-radius:12px!important;background:#fff;color:#000;font-weight:800;text-align:center;font-size:22px!important;outline:0;letter-spacing:4px;min-height:60px;position:relative;z-index:2}.input-field::placeholder{color:#666;letter-spacing:normal;font-size:16px}.password-dots-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:#fff;display:none;align-items:center;justify-content:center;pointer-events:none;border-radius:12px;font-size:24px;letter-spacing:8px;color:#000;font-weight:800;z-index:3}.start-col{position:absolute;right:20px;bottom:280px;display:flex;align-items:center;justify-content:center;z-index:10000}.start-btn{padding:24px 36px!important;border-radius:16px!important;background:#0b5138;color:#fff;border:none;font-weight:900;font-size:26px!important;cursor:pointer;box-shadow:0 12px 40px rgba(0,0,0,.4);min-height:100px;min-width:180px;transition:all .3s ease}.start-btn:hover{background:#0a6e2d!important;transform:translateY(-2px);box-shadow:0 6px 20px rgba(11,81,56,.6)}.challenge-col{position:absolute;right:20px;bottom:20px;display:flex;align-items:center;justify-content:center;z-index:10000}.challenge-col-game{position:absolute;right:20px;bottom:20px;display:flex;align-items:center;justify-content:center;z-index:10000}.challenge-btn{padding:20px 30px!important;border-radius:16px!important;background:#0a84ff!important;color:#fff!important;border:none;font-weight:900;font-size:22px!important;cursor:pointer;box-shadow:0 12px 40px rgba(10,132,255,.4);min-height:80px;min-width:160px;transition:all .3s ease}.challenge-btn:hover{background:#0071e3!important;transform:translateY(-2px);box-shadow:0 6px 20px rgba(10,132,255,.6)}.challenge-input-container{position:absolute;right:20px;bottom:160px;background:rgba(255,255,255,.95);padding:20px;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,.3);z-index:10001;display:none;flex-direction:column;gap:12px;min-width:250px}#challengeDuration{padding:16px;border:2px solid #0a84ff;border-radius:12px;font-size:18px;font-weight:800;text-align:center;outline:0}#challengeDuration::placeholder{color:#666;text-align:center}.confirm-btn{padding:16px 24px;border-radius:12px;background:#0a84ff;color:#fff;border:none;font-weight:900;font-size:18px;cursor:pointer;transition:all .3s ease}.confirm-btn:hover{background:#0071e3;transform:translateY(-2px)}.game{height:100%;display:grid;grid-template-columns:1fr 460px;grid-template-rows:120px 1fr;gap:12px;align-items:start}.word-top-section{grid-column:1/-1;display:flex;justify-content:center;align-items:center;padding:5px 10px;margin-top:-20px}.slots-row{display:flex;justify-content:center;gap:var(--slot-gap,12px);align-items:center;min-height:90px;margin-top:-10px!important}.left-game{position:relative;display:flex;align-items:flex-start;justify-content:center;padding-top:40px;width:100%;padding-top:0}.game-tree-frame{width:100%!important;max-width:750px!important;aspect-ratio:4/3;position:relative;margin-left:-200px;margin-top:-110px}.game-tree-img{position:absolute;left:40%;top:62%;transform:translate(-50%,-50%);width:120%!important;height:120%!important;object-fit:contain!important;border-radius:8px}.right-col{display:flex;flex-direction:column;gap:10px;padding:6px;height:100%}.tree-apples{position:absolute;left:12%!important;top:8%;width:76%!important;height:84%;pointer-events:none}.slot{min-width:36px;border-bottom:3px solid rgba(255,255,255,.12);padding:6px 8px;text-align:center;font-weight:900;font-size:var(--slot-font,30px);color:#fff}.slot.space{border-bottom:none}.alphabet{display:flex;flex-wrap:wrap;gap:8px;padding:8px;border-radius:8px;min-height:160px;align-items:flex-start;overflow:auto;justify-content:center}.letter-btn{padding:8px 10px;border-radius:8px;border:1px solid rgba(0,0,0,.06);background:rgba(255,255,255,.94);cursor:pointer;min-width:40px;text-align:center;font-weight:800}.letter-btn.disabled{opacity:.28;cursor:default}.fallen-columns{display:flex;gap:12px;overflow:auto;padding-top:100px;align-items:flex-start}.fallen-column{display:flex;flex-direction:column;gap:10px;align-items:center;width:84px}.fallen-item{display:flex;flex-direction:row;align-items:center;gap:8px}.fallen-letter{font-weight:900;font-size:18px;color:#111;margin-left:4px}.new-bottom{position:absolute;right:20px;top:350px;z-index:8}.new-btn{padding:35px 20px;border-radius:42px;background:#86198f!important;color:#fff!important;border:none;cursor:pointer;font-weight:800;font-size:16px;box-shadow:0 4px 12px rgba(139,92,246,.3);transition:all .3s ease;min-height:50px}.new-btn:hover{background:#5d2a2c!important;transform:translateY(-2px);box-shadow:0 6px 16px rgba(139,92,246,.4)}.modal{position:fixed;left:0;top:0;right:0;bottom:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:9999}.modal.show{display:flex}.modal-card{background:#fff;padding:18px;border-radius:12px;min-width:320px;text-align:center}.modal-card img{max-width:320px;height:auto;border-radius:8px;margin:8px 0}.modal-btn{margin-top:12px;padding:8px 12px;border-radius:8px;border:none;background:#0b5138;color:#fff;cursor:pointer}@media (max-width:1024px) and (orientation:landscape){.tree-apples .apple-item img{width:15px!important}.fallen-item img{width:20px!important}.fallen-column{width:70px}.fallen-letter{font-size:14px}.tree-apples{transform:scale(.88)!important}.apple-item{transform:translate(-8px,-6px)!important}.wrap{padding:5px;height:100vh;display:block}.stage{height:100vh;max-width:100%;border-radius:0}.page{height:calc(100vh - 20px);padding:10px}.lang-col{margin-top:60px!important}.tree-wrap{height:35vh}.tree-frame{width:65%!important;max-width:300px!important;margin-left:-260px!important;margin-top:100px!important}.input-container{position:absolute;width:450px!important;right:150px;top:170px!important}.input-field{padding:12px 16px!important;font-size:18px!important;min-height:50px}.start-col{position:absolute;right:20px;top:40px!important}.start-btn{width:120px;padding:12px 20px!important;font-size:16px!important;min-height:50px;min-width:120px}.new-bottom{position:absolute!important;order:3;top:40px!important;right:20px!important;transform:none}.new-btn{width:120px;padding:12px 20px!important;font-size:16px!important;min-height:50px;min-width:120px}.right-col{grid-row:2;height:7vh;margin-top:-45px!important;gap:1px;padding:3px}.alphabet{margin-top:0!important;z-index:1000!important;position:relative!important}.letter-btn{padding:4px 7px!important;min-width:20px!important;min-height:20px!important;font-size:13px!important}.challenge-btn{width:120px;padding:12px 20px!important;font-size:16px!important;min-height:50px;min-width:120px}.challenge-col{position:absolute;right:20px;top:100px!important}.challenge-col-game{position:absolute;right:20px;bottom:90px!important}.challenge-input-container{right:50px;bottom:180px!important}.game{grid-template-columns:1fr 380px;grid-template-rows:100px 1fr;gap:10px;height:100%}.game-tree-frame{width:80%!important;max-width:300px!important;margin:0 auto!important;margin-left:0!important;margin-top:-60px!important}.game-tree-img{width:180%!important;height:100%!important;left:35%!important;top:55%!important;object-fit:contain!important}.timer-container{top:15px;right:15px;padding:10px 16px;font-size:18px;min-width:70px}.slots-row{flex-wrap:wrap;justify-content:center;gap:4px!important}.slot{min-width:28px;font-size:20px!important;padding:4px 6px}header .controls{bottom:20px!important;right:10px!important}.sound-toggle{width:36px!important;height:36px!important}.fallen-columns{flex-direction:row!important;flex-wrap:nowrap!important;align-items:flex-end!important;position:absolute!important;bottom:20px!important;left:0!important;right:0!important;padding:8px!important;overflow-x:auto!important;background:rgba(0,0,0,.2)!important}.fallen-column{flex-direction:row!important;gap:6px!important;width:auto!important}.fallen-item img{width:32px!important}}@media (max-width:768px) and (orientation:portrait){.tree-apples .apple-item img{width:15px!important}.fallen-item img{width:20px!important}.tree-apples{transform:scale(.88)!important}.apple-item{transform:translate(-8px,-6px)!important}.wrap{padding:5px;height:100vh;display:block;overflow:hidden}.stage{height:100vh;max-width:100%;border-radius:0}.page{height:calc(100vh - 10px);padding:5px}header .title{bottom:10px;font-size:12px;padding:6px 12px;transform:translateX(-50%);left:50%;width:90%;text-align:center;white-space:normal}header .controls{bottom:10px;right:10px}.sound-toggle{width:36px;height:36px}.timer-container{top:10px;right:10px;padding:8px 14px;font-size:16px;min-width:65px}#pageSetup.active{display:flex;flex-direction:column;align-items:center;justify-content:flex-start;height:100vh;position:relative}.setup{display:flex;flex-direction:column;height:100%;width:100%;grid-template-columns:1fr;gap:10px}.tree-wrap{order:1;height:50vh;width:90%;margin-top:20px}.tree-frame{width:95%!important;max-width:100%!important;margin:0!important;height:110%}.tree-img{position:relative!important;left:50%!important;top:50%!important;transform:translate(-50%,-50%)!important;width:100%!important;height:110%!important;object-fit:contain!important}.input-container{position:absolute!important;order:2;width:90%!important;bottom:50vh!important;left:50%!important;transform:translateX(-50%);top:auto!important;right:auto!important;z-index:20}.input-field{padding:14px 16px!important;font-size:18px!important;min-height:55px;background:#fff!important;opacity:1!important;border:2px solid #0b5138}.password-dots-overlay{border-radius:12px;font-size:20px;letter-spacing:6px}.start-col{position:absolute!important;order:3;bottom:40vh;right:5%;left:auto!important;transform:none}.challenge-col{position:absolute!important;order:3;bottom:17vh;right:1%;transform:none}.challenge-col-game{position:absolute!important;bottom:17vh!important;right:1%;transform:none}.challenge-btn{width:120px;padding:12px 20px!important;font-size:16px!important;min-height:50px;min-width:120px}.challenge-input-container{position:absolute!important;bottom:20vh;right:5%;width:60%!important}.start-btn{width:120px;padding:12px 20px!important;font-size:16px!important;min-height:50px;border-radius:12px!important}.challenge-btn{width:100px;padding:10px 16px!important;font-size:14px!important;min-height:40px;border-radius:12px!important}.lang-col{position:absolute;order:4;left:5%;bottom:5vh;margin-top:0;flex-direction:column;gap:6px}.lang-btn{width:50px;height:30px;font-size:10px}#pageGame.active{display:flex;flex-direction:column;height:100vh;position:relative}.game{display:flex;flex-direction:column;height:100%;width:100%;grid-template-columns:1fr;grid-template-rows:auto auto 1fr;gap:8px}.word-top-section{order:1;height:15vh;margin-top:0;padding:5px 0}.slots-row{min-height:50px;margin-top:0!important;gap:1px!important;padding:0 5px!important;flex-wrap:wrap;justify-content:center}.left-game{order:2;height:25vh;position:relative;padding:0;margin:0}.game-tree-frame{width:65%!important;max-width:300px!important;margin:0 auto!important;height:100%}.game-tree-img{width:100%!important;height:100%!important;left:40%!important;top:6 0!important;object-fit:contain!important}.new-bottom{position:absolute!important;order:3;top:270px!important;right:3%;transform:none}.new-btn{padding:8px 16px;border-radius:20px;font-size:12px;min-height:40px}.right-col{order:4;height:50vh;display:flex;flex-direction:row;gap:8px;padding:5px;margin-top:10px}.fallen-columns{flex:1;padding-top:10px;max-height:100%;justify-content:flex-start;overflow-y:auto}.fallen-column{width:70px}.fallen-item img{width:30px!important}.fallen-letter{font-size:12px}.alphabet{flex:2;min-height:auto;max-height:100%;overflow-y:auto;padding:5px;gap:4px}.letter-btn{padding:8px 10px;min-width:32px;min-height:32px;font-size:12px}.slots-row{flex-wrap:wrap;justify-content:center;gap:2px!important;max-height:80px;overflow-y:auto}.slot{min-width:24px;font-size:16px!important;padding:3px 4px;margin:1px}.slot.space{width:12px}}@media (max-width:380px) and (orientation:portrait){.tree-wrap{height:45vh}.input-container{bottom:20vh;width:95%!important}.start-col{bottom:40vh}.challenge-col{bottom:17vh}.challenge-col-game{bottom:17vh!important}.challenge-input-container{bottom:20vh}.lang-col{bottom:25vh}.right-col{height:45vh}.timer-container{top:8px;right:8px;padding:6px 12px;font-size:14px;min-width:60px}.slots-row{gap:1px!important}.slot{min-width:20px;font-size:14px!important;padding:2px 3px}}</style><div id=loadingScreen style=position:fixed;top:0;left:0;width:100%;height:100%;background:#0b5138;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100000;color:#fff;font-family:Inter,Arial><div style=text-align:center;margin-bottom:30px><h1 style=font-size:2.5em;margin-bottom:10px>AppelBoom</h1><p style=font-size:1.2em>ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</div><div style=width:300px;height:20px;background:rgba(255,255,255,.2);border-radius:10px;overflow:hidden><div id=loadingProgress style="width:0%;height:100%;background:#0a84ff;transition:width .3s ease;border-radius:10px"></div></div><div style=margin-top:15px;font-size:.9em><span id=loadedCount>0</span> / <span id=totalCount>0</span></div></div><script>/* ================= SETTINGS ================= */
const settings = {
  images: {
    background: "background.jpg",
    tree: "tree.png",
    apple: "apple.png",
    appleTransparent: "apple_transparent.png",
    crowdFail: "crowd_fail.jpg",
    crowdWin: "crowd_win.jpg",
    winImage: "win.jpg"
  },
  sounds: {
    birds: "birds.mp3",
    click: "click1.mp3",
    fallWhistle: "fall_whistle.mp3",
    impact: "impact.mp3",
    slide: "slide.mp3",
    successList: ["success1.mp3","success2.mp3"],
    failList: ["fail1.mp3","fail2.mp3"],
    successMessage: "success_message.mp3",
    failMessage: "fail_message.mp3"
  },
  options: {
    sound_enabled: true,
    check_dictionary_online: false,
    maxApplesPerColumn: 3,
    fallDurationMs: 700,
    bounceDurationMs: 420,
    bounceTiltDeg: 28,
    appleSizeBasePx: 38,
    slotFontSizePx: 26,
    slotUnderscoreSpacing: 10,
    arabicWordsFile: "assets/words_ar.json",
  },
  reportSalt: "change-this-to-server-salt-or-remove",
};</script><div class=wrap><div class=stage id=stage><div class=bg id=bg></div><header><div class=title>AppelBoom v3.0 - Designed by Khaled Albadawi (khaledalbadawi.a@gmail.com)</div><div class=controls><button class=sound-toggle id=soundToggle aria-label="ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑÿµŸàÿ™"></button></div></header><div class=timer-container id=timerContainer><span id=timerDisplay>00:00</span></div><section class="active page"id=pageSetup><div class=setup><div class=lang-col id=langCol><div class="lang-btn active"data-lang=nl>NL</div><div class=lang-btn data-lang=en>EN</div><div class=lang-btn data-lang=ar>AR</div></div><div class=tree-wrap><div class=tree-frame><img alt=tree class=tree-img id=heroTree src=""><div class=hero-apples id=heroApples></div></div></div></div><div class=input-container><input id=wordInput placeholder="Typ het woord..."autocomplete=off class=input-field><div class=password-dots-overlay id=passwordDots></div></div><div class=challenge-col><button class=challenge-btn id=challengeBtn>ÿ™ÿ≠ÿØŸä</button></div><div class=start-col><button class=start-btn id=startBtn>Start</button></div></section><section class=page id=pageGame aria-hidden=true><div class=game><div class=word-top-section><div class=slots-row id=slotsRow></div></div><div class=left-game><div class=game-tree-frame><img alt=tree class=game-tree-img id=gameTree src=""><div class=tree-apples id=treeApples></div></div></div><div class=right-col><div class=alphabet id=alphabet></div><div class=fallen-columns id=fallenColumns></div></div><div class=challenge-col-game><button class=challenge-btn id=challengeBtnGame>ÿ™ÿ≠ÿØŸä</button></div><div class=new-bottom><button class=new-btn id=newBtn>Nieuw / New</button></div></div></section><div class=challenge-input-container><input id=challengeDuration placeholder="ÿßŸÑŸàŸÇÿ™ ÿ®ÿßŸÑÿ´ŸàÿßŸÜŸä"max=300 min=10 type=number> <button class=confirm-btn id=confirmChallenge>ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ™ÿ≠ÿØŸä</button></div><div class=modal id=modal><div class=modal-card><h2 id=modalTitle></h2><div id=modalMedia></div><p id=modalDesc><div style=display:flex;gap:8px;justify-content:center;margin-top:8px><button class=modal-btn id=modalOk>OK</button> <button class=modal-btn id=shareReportBtn style=background:#0a84ff>ŸÖÿ¥ÿßÿ±ŸÉÿ© ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±</button></div></div></div></div></div><script>/* ================= ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ™ÿØÿ±ÿ¨ ================= */
const imageLoader = {
  loaded: 0,
  total: 0,
  images: {},
  
  load: function(images, callback) {
    this.total = Object.keys(images).length;
    this.loaded = 0;
    
    for (const [key, src] of Object.entries(images)) {
      this.images[key] = new Image();
      this.images[key].onload = () => {
        this.loaded++;
        this.updateProgress();
        if (this.loaded === this.total && callback) {
          callback();
        }
      };
      this.images[key].onerror = () => {
        this.loaded++;
        this.updateProgress();
        console.warn(`Failed to load image: ${src}`);
        if (this.loaded === this.total && callback) {
          callback();
        }
      };
      this.images[key].src = src;
    }
  },
  
  updateProgress: function() {
    const progress = (this.loaded / this.total) * 100;
    const progressBar = document.getElementById('loadingProgress');
    if (progressBar) {
      progressBar.style.width = progress + '%';
    }
  },
  
  get: function(key) {
    return this.images[key];
  }
};

/* ================= Appelboom v3.0 - Mobile Optimized + Challenge/Share ================= */
(async function(){
  // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä ŸÖÿ§ŸÇÿ™ÿßŸã
  const stage = document.getElementById('stage');
  stage.style.display = 'none';
  
  // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ± ÿ®ÿ¥ŸÉŸÑ ŸÖÿ™ÿØÿ±ÿ¨
  const imagesToLoad = {
    background: settings.images.background,
    tree: settings.images.tree,
    apple: settings.images.apple,
    appleTransparent: settings.images.appleTransparent,
    crowdFail: settings.images.crowdFail,
    crowdWin: settings.images.crowdWin,
    winImage: settings.images.winImage
  };
  
  // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿØÿßÿØ
  document.getElementById('totalCount').textContent = Object.keys(imagesToLoad).length;
  document.getElementById('loadedCount').textContent = '0';
  
  imageLoader.load(imagesToLoad, function() {
    // ÿ®ÿπÿØ ÿßŸÉÿ™ŸÖÿßŸÑ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑÿå ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿµŸàÿ±
    const bg = document.getElementById('bg');
    const heroTree = document.getElementById('heroTree');
    const gameTree = document.getElementById('gameTree');
    
    bg.style.backgroundImage = `url("${settings.images.background}")`;
    heroTree.src = settings.images.tree;
    gameTree.src = settings.images.tree;
    
    // ÿ•ÿÆŸÅÿßÿ° ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ Ÿàÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä
    setTimeout(() => {
      document.getElementById('loadingScreen').style.opacity = '0';
      document.getElementById('loadingScreen').style.transition = 'opacity 0.5s ease';
      setTimeout(() => {
        document.getElementById('loadingScreen').remove();
        stage.style.display = 'block';
        renderHeroApples();
      }, 500);
    }, 500);
  });
  
  // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿØÿßÿØ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
  const updateCounter = setInterval(() => {
    document.getElementById('loadedCount').textContent = imageLoader.loaded;
    if (imageLoader.loaded === imageLoader.total) {
      clearInterval(updateCounter);
    }
  }, 100);

  // DOM refs
  const heroApples = document.getElementById('heroApples');
  const treeApples = document.getElementById('treeApples');
  const wordInput = document.getElementById('wordInput');
  const passwordDots = document.getElementById('passwordDots');
  const startBtn = document.getElementById('startBtn');
  const langCol = document.getElementById('langCol');
  const langEls = langCol.querySelectorAll('.lang-btn');
  const soundToggle = document.getElementById('soundToggle');
  const pageSetup = document.getElementById('pageSetup');
  const pageGame = document.getElementById('pageGame');
  const slotsRow = document.getElementById('slotsRow');
  const alphabetDiv = document.getElementById('alphabet');
  const fallenColumns = document.getElementById('fallenColumns');
  const newBtn = document.getElementById('newBtn');
  const modal = document.getElementById('modal');
  const modalTitle = document.getElementById('modalTitle');
  const modalMedia = document.getElementById('modalMedia');
  const modalDesc = document.getElementById('modalDesc');
  const modalOk = document.getElementById('modalOk');
  const shareReportBtn = document.getElementById('shareReportBtn');
  const challengeBtn = document.getElementById('challengeBtn');
  const challengeBtnGame = document.getElementById('challengeBtnGame');
  const challengeInputContainer = document.querySelector('.challenge-input-container');
  const challengeDurationInput = document.getElementById('challengeDuration');
  const confirmChallengeBtn = document.getElementById('confirmChallenge');
  const timerContainer = document.getElementById('timerContainer');
  const timerDisplay = document.getElementById('timerDisplay');

  // state
  const ALPHABETS = {
    nl: ["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","√Å","√Ä","√â","√à","√ã","√ç","√è","√ì","√ñ","√ö","√ú"],
    en: ["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],
    ar: ["ÿß","ÿ£","ÿ•","ÿ¢","ÿ®","ÿ™","ÿ´","ÿ¨","ÿ≠","ÿÆ","ÿØ","ÿ∞","ÿ±","ÿ≤","ÿ≥","ÿ¥","ÿµ","ÿ∂","ÿ∑","ÿ∏","ÿπ","ÿ∫","ŸÅ","ŸÇ","ŸÉ","ŸÑ","ŸÖ","ŸÜ","Ÿá","Ÿà","ÿ§","Ÿä","ÿ¶","Ÿâ"]
  };

  // ŸÉÿßÿ¶ŸÜ ÿßŸÑÿ™ÿ±ÿ¨ŸÖÿ©
  const TRANSLATIONS = {
    nl: {
      challengeBtn: "Uitdaging",
      newBtn: "Nieuw Spel",
      modalOk: "OK",
      shareReportBtn: "Deel Rapport",
      startBtn: "Start",
      wordPlaceholder: "Typ het woord...",
      timeUp: "Tijd is om!",
      congrats: "Gefeliciteerd!",
      applesFinished: "Alle appels zijn gevallen",
      guessedWord: "Je hebt het woord geraden!",
      wordWas: "Het woord was: ",
      enterWord: "Voer een woord in.",
      challengePrompt: "Tijd in seconden (bijv. 60)",
      acceptChallenge: "Wil je de uitdaging accepteren?",
      wordLength: "Woordlengte: ",
      typeChallengeWord: "Typ een woord voor de uitdaging eerst",
      copyLink: "Kopieer de link en deel",
      challengeText: "Appel uitdaging - {seconds} seconden",
      noReport: "Geen rapport beschikbaar",
      reportCopied: "Rapport JSON gekopieerd naar klembord",
      timePlaceholder: "Tijd in seconden",
      confirmChallenge: "Bevestig Uitdaging",
      challengeUsed: "Uitdaging Al Gespeeld",
      challengeUsedDesc: "Deze uitdaging is al eerder gespeeld op dit apparaat!",
      timeElapsed: "Tijd gebruikt: ",
      seconds: "seconden"
    },
    en: {
      challengeBtn: "Challenge",
      newBtn: "New Game",
      modalOk: "OK",
      shareReportBtn: "Share Report",
      startBtn: "Start",
      wordPlaceholder: "Type the word...",
      timeUp: "Time's up!",
      congrats: "Congratulations!",
      applesFinished: "Apples finished",
      guessedWord: "You guessed the word!",
      wordWas: "The word was: ",
      enterWord: "Please enter a word.",
      challengePrompt: "Duration in seconds (e.g. 60)",
      acceptChallenge: "Do you want to accept the challenge?",
      wordLength: "Word length: ",
      typeChallengeWord: "Type a word for the challenge first",
      copyLink: "Copy the link and share",
      challengeText: "Apple challenge - {seconds} seconds",
      noReport: "No report available",
      reportCopied: "Report JSON copied to clipboard",
      timePlaceholder: "Time in seconds",
      confirmChallenge: "Confirm Challenge",
      challengeUsed: "Challenge Already Played",
      challengeUsedDesc: "This challenge has been played before on this device!",
      timeElapsed: "Time used: ",
      seconds: "seconds"
    },
    ar: {
      challengeBtn: "ÿ™ÿ≠ÿØŸä",
      newBtn: "ŸÑÿπÿ®ÿ© ÿ¨ÿØŸäÿØÿ©",
      modalOk: "ŸÖŸàÿßŸÅŸÇ",
      shareReportBtn: "ŸÖÿ¥ÿßÿ±ŸÉÿ© ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±",
      startBtn: "ÿßÿ®ÿØÿ£",
      wordPlaceholder: "ÿßŸÉÿ™ÿ® ÿßŸÑŸÉŸÑŸÖÿ©...",
      timeUp: "ÿßŸÜÿ™ŸáŸâ ÿßŸÑŸàŸÇÿ™!",
      congrats: "ŸÖÿ®ÿ±ŸàŸÉ!",
      applesFinished: "ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑÿ™ŸÅÿßÿ≠ÿßÿ™",
      guessedWord: "ŸÑŸÇÿØ ÿÆŸÖŸÜÿ™ ÿßŸÑŸÉŸÑŸÖÿ©!",
      wordWas: "ÿßŸÑŸÉŸÑŸÖÿ© ŸÉÿßŸÜÿ™: ",
      enterWord: "ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ©.",
      challengePrompt: "ÿßŸÑŸÖÿØÿ© ÿ®ÿßŸÑÿ´ŸàÿßŸÜŸä (ŸÖÿ´ÿßŸÑ: 60)",
      acceptChallenge: "ŸáŸÑ ÿ™ÿ±ŸäÿØ ŸÇÿ®ŸàŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿü",
      wordLength: "ÿπÿØÿØ ÿ£ÿ≠ÿ±ŸÅ ÿßŸÑŸÉŸÑŸÖÿ©: ",
      typeChallengeWord: "ÿßŸÉÿ™ÿ® ŸÉŸÑŸÖÿ© ŸÑŸÑÿ™ÿ≠ÿØŸä ÿ£ŸàŸÑÿßŸã",
      copyLink: "ÿßŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑ Ÿàÿ¥ÿßÿ±ŸÉŸá",
      challengeText: "ÿ™ÿ≠ÿØŸä ÿ™ŸÅÿßÿ≠ - {seconds} ÿ´ÿßŸÜŸäÿ©",
      noReport: "ŸÑÿß ŸäŸàÿ¨ÿØ ÿ™ŸÇÿ±Ÿäÿ±",
      reportCopied: "ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ•ŸÑŸâ ÿßŸÑÿ≠ÿßŸÅÿ∏ÿ©",
      timePlaceholder: "ÿßŸÑŸàŸÇÿ™ ÿ®ÿßŸÑÿ´ŸàÿßŸÜŸä",
      confirmChallenge: "ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ™ÿ≠ÿØŸä",
      challengeUsed: "ÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ™ÿ≠ÿØŸä",
      challengeUsedDesc: "Ÿáÿ∞ÿß ÿßŸÑÿ™ÿ≠ÿØŸä ÿ™ŸÖ ŸÑÿπÿ®Ÿá ŸÖÿ≥ÿ®ŸÇÿßŸã ÿπŸÑŸâ Ÿáÿ∞ÿß ÿßŸÑÿ¨Ÿáÿßÿ≤!",
      timeElapsed: "ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿ∫ÿ±ŸÇ: ",
      seconds: "ÿ´ÿßŸÜŸäÿ©"
    }
  };

  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

  const state = {
    lang: 'nl',
    wordRaw: '',
    wordChars: [],
    maxApples: 0,
    apples: [],
    fallenCount: 0,
    slots: [],
    alphabetButtons: [],
    audioEnabled: !!settings.options.sound_enabled,
    successIndex: 0,
    failIndex: 0,
    arabicWords: null,
    activeChallenge: null,
    lastFailSoundTime: 0,
    gameEndSoundPlayed: false,
    challengeStartTime: 0, // üî• ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿ∞Ÿä ÿ®ÿØÿ£ ŸÅŸäŸá ÿßŸÑÿ™ÿ≠ÿØŸä
    firstGuessTime: 0, // üî• ŸàŸÇÿ™ ÿ£ŸàŸÑ ÿ™ÿÆŸÖŸäŸÜ
    gameStartTime: 0 // üî• ŸàŸÇÿ™ ÿ®ÿØÿ° ÿßŸÑŸÑÿπÿ®ÿ©
  };

  // üî• ÿØÿßŸÑÿ© ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑÿ™ÿ≠ÿØŸäÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ©
  function cleanupOldChallenges() {
    const playedChallenges = JSON.parse(localStorage.getItem('playedChallenges') || '{}');
    const now = Date.now();
    const oneWeek = 7 * 24 * 60 * 60 * 1000; // ÿ£ÿ≥ÿ®Ÿàÿπ Ÿàÿßÿ≠ÿØ
    
    for (const challengeId in playedChallenges) {
        if (now - playedChallenges[challengeId].playedAt > oneWeek) {
            delete playedChallenges[challengeId];
        }
    }
    
    localStorage.setItem('playedChallenges', JSON.stringify(playedChallenges));
  }

  // üî• ÿßÿ≥ÿ™ÿØÿπÿßÿ° ÿßŸÑÿ™ŸÜÿ∏ŸäŸÅ ÿπŸÜÿØ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
  cleanupOldChallenges();

  // audio helper ŸÖÿπ ŸÖŸÜÿπ ÿßŸÑÿ™ŸÉÿ±ÿßÿ±
  function playAudio(src, vol=1){ 
    if(!state.audioEnabled) return; 
    try{ 
      const a=new Audio(src); 
      a.volume=Math.min(1,vol); 
      a.play().catch(()=>{}); 
    }catch(e){}
  }

  function uiClick(){ playAudio(settings.sounds.click, 0.12); }

  // ÿØÿßŸÑÿ© ÿ¨ÿØŸäÿØÿ© ŸÑŸÖŸÜÿπ ÿ™ŸÉÿ±ÿßÿ± ÿµŸàÿ™ ÿßŸÑÿÆÿ∑ÿ£
  function playFailSound() {
    const now = Date.now();
    // ŸÖŸÜÿπ ÿ™ŸÉÿ±ÿßÿ± ÿßŸÑÿµŸàÿ™ ÿÆŸÑÿßŸÑ 800 ŸÖŸÑŸÑŸä ÿ´ÿßŸÜŸäÿ©
    if (now - state.lastFailSoundTime > 800) {
      const fl = settings.sounds.failList || [];
      if (fl.length > 0) {
        // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÖÿ§ÿ¥ÿ± ŸÖŸÜŸÅÿµŸÑ ŸÑŸÑÿµŸàÿ™ ŸÑŸÖŸÜÿπ ÿßŸÑÿ™ÿπÿßÿ±ÿ∂
        const soundIndex = state.failIndex % fl.length;
        playAudio(fl[soundIndex], 0.18);
        state.failIndex = (state.failIndex + 1) % fl.length; // ŸÖŸÜÿπ ÿ™ÿ¨ÿßŸàÿ≤ ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ
      }
      state.lastFailSoundTime = now;
    }
  }

  const birdsAudio = new Audio(settings.sounds.birds); 
  birdsAudio.loop=true; 
  birdsAudio.volume=0.25;
  
  function playBirds(){ if(state.audioEnabled){ birdsAudio.play().catch(()=>{}); } }
  function stopBirds(){ try{ birdsAudio.pause(); birdsAudio.currentTime=0; }catch(e){} }

  // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÉŸÑŸÖÿ© ŸäÿØŸàŸäÿßŸã
  wordInput.addEventListener('input', function() {
    const dots = '‚Ä¢'.repeat(this.value.length);
    passwordDots.textContent = dots;
    if (this.value.length > 0) {
        passwordDots.style.display = 'flex';
    } else {
        passwordDots.style.display = 'none';
    }
  });

  // üî• ÿßŸÑÿ•ÿµŸÑÿßÿ≠ ÿßŸÑŸÜŸáÿßÿ¶Ÿä: ÿ•ÿ∂ÿßŸÅÿ© event listener ŸÑŸÑŸÄ Enter ŸÅŸä ÿ≠ŸÇŸÑ ÿßŸÑÿ•ÿØÿÆÿßŸÑ
  wordInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault(); // ŸÖŸÜÿπ ÿßŸÑÿ≥ŸÑŸàŸÉ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä (ŸÖÿ≥ÿ≠ ÿßŸÑŸÉŸÑŸÖÿ©)
        // ÿ•ÿ∂ÿßŸÅÿ© ÿ™ÿ£ÿÆŸäÿ± ÿ®ÿ≥Ÿäÿ∑ ŸÑÿ∂ŸÖÿßŸÜ ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿ£ŸÖÿ±
        setTimeout(() => {
            startBtn.click(); // ÿ™ŸÅÿπŸäŸÑ ÿ≤ÿ± Start
        }, 10);
    }
  });

  function disableAllLetters() {
    state.alphabetButtons.forEach(btn => {
        btn.disabled = true;
        btn.classList.add('disabled');
    });
  }

  function updateAllTexts() {
    const lang = state.lang;
    const t = TRANSLATIONS[lang];
    
    // ÿ™ÿ≠ÿØŸäÿ´ ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑŸàÿßÿ¨Ÿáÿ© ŸÅŸä ŸÉŸÑÿß ÿßŸÑÿµŸÅÿ≠ÿ™ŸäŸÜ
    challengeBtn.textContent = t.challengeBtn;
    challengeBtnGame.textContent = t.challengeBtn;
    newBtn.textContent = t.newBtn;
    modalOk.textContent = t.modalOk;
    shareReportBtn.textContent = t.shareReportBtn;
    startBtn.textContent = t.startBtn;
    
    // ÿ™ÿ≠ÿØŸäÿ´ placeholder
    wordInput.placeholder = t.wordPlaceholder;
    challengeDurationInput.placeholder = t.timePlaceholder;
    confirmChallengeBtn.textContent = t.confirmChallenge;
  }

  langEls.forEach(el=>{
    el.addEventListener('click', ()=>{ 
        langEls.forEach(x=>x.classList.remove('active')); 
        el.classList.add('active'); 
        state.lang = el.dataset.lang; 
        updateAllTexts(); 
        uiClick(); 
    });
  });

  // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÜÿµŸàÿµ ÿπŸÜÿØ ÿßŸÑÿ®ÿØÿ°
  updateAllTexts();

  // hero apples render
  function renderHeroApples(){
    heroApples.innerHTML='';
    const positions = [
      {x:13,y:-2},{x:23,y:5},{x:33,y:-2},{x:43,y:5},{x:53,y:-2},{x:63,y:5},{x:73,y:-2},
      {x:4,y:30},{x:14,y:37},{x:24,y:30},{x:34,y:37},{x:44,y:30},{x:54,y:37},{x:64,y:30},{x:74,y:37},{x:84,y:30}
    ];
    const label='KHALEDSAPPELBOOM'.split('');
    positions.forEach((p,i)=>{
      const w=document.createElement('div'); w.className='apple-item';
      w.style.left=p.x+'%'; w.style.top=p.y+'%';
      const img=document.createElement('img'); img.src=settings.images.appleTransparent; img.style.width='38px'; img.style.opacity='0.85';
      w.appendChild(img);
      const span=document.createElement('div'); span.textContent = label[i%label.length];
      span.style.position='absolute'; span.style.left='50%'; span.style.top='50%'; span.style.transform='translate(-50%,-52%)';
      span.style.fontWeight='900'; span.style.fontSize='18px'; span.style.color='#000';
      w.appendChild(span); heroApples.appendChild(w);
    });
  }

  async function loadArabicWords(){
    try{
      const res = await fetch(settings.options.arabicWordsFile);
      if(!res.ok) throw new Error('no ar words');
      state.arabicWords = await res.json();
    }catch(e){ state.arabicWords = null; console.warn('ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ ŸÉŸÑŸÖÿßÿ™ ÿπÿ±ÿ®Ÿäÿ© ŸÖÿ≠ŸÑŸä:', e); }
  }
  await loadArabicWords();

  // üî• ÿØŸàÿßŸÑ ÿßŸÑŸÖÿ§ŸÇÿ™ ÿßŸÑŸÖÿπÿØŸÑÿ©
  function startChallengeTimer(durationSec) {
      if (!state.activeChallenge) return;
      state.activeChallenge.durationSec = durationSec;
      state.activeChallenge.timeLeft = durationSec;
      state.activeChallenge.timerInterval = null; // üî• ŸÑÿß ŸÜÿ®ÿØÿ£ ÿßŸÑŸÖÿ§ŸÇÿ™ ÿ®ÿπÿØ
      timerContainer.classList.add('visible');
      updateTimerDisplay();
  }

  function startTimerOnFirstGuess() {
      if (state.activeChallenge && !state.activeChallenge.timerInterval) {
          state.activeChallenge.timerInterval = setInterval(updateTimer, 1000);
          state.challengeStartTime = Date.now(); // üî• ÿ≠ŸÅÿ∏ ŸàŸÇÿ™ ÿ®ÿØÿ° ÿßŸÑÿ™ÿ≠ÿØŸä ÿßŸÑŸÅÿπŸÑŸä
      }
  }

  function updateTimer() {
      if (!state.activeChallenge || state.activeChallenge.timeLeft <= 0) {
          endChallengeTimer();
          return;
      }
      state.activeChallenge.timeLeft--;
      updateTimerDisplay();
      if (state.activeChallenge.timeLeft <= 10) {
          timerContainer.classList.add('warning');
          if (state.activeChallenge.timeLeft <= 5 && state.audioEnabled) {
              playAudio(settings.sounds.click, 0.2);
          }
      }
      if (state.activeChallenge.timeLeft <= 0) {
          endChallengeTimer();
          handleTimeUp();
      }
  }

  function updateTimerDisplay() {
      if (!state.activeChallenge) return;
      const minutes = Math.floor(state.activeChallenge.timeLeft / 60);
      const seconds = state.activeChallenge.timeLeft % 60;
      timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  }

  function endChallengeTimer() {
      if (state.activeChallenge && state.activeChallenge.timerInterval) {
          clearInterval(state.activeChallenge.timerInterval);
          state.activeChallenge.timerInterval = null;
      }
      timerContainer.classList.remove('visible', 'warning');
  }

  // üî• ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿ∫ÿ±ŸÇ
  function getElapsedTime() {
      if (!state.firstGuessTime) return 0;
      const endTime = Date.now();
      return Math.floor((endTime - state.firstGuessTime) / 1000);
  }

  // üî• ÿßŸÑÿ•ÿµŸÑÿßÿ≠ ÿßŸÑŸÜŸáÿßÿ¶Ÿä: ÿ™ÿπÿØŸäŸÑ ÿØÿßŸÑÿ© handleTimeUp
  function handleTimeUp() {
    endChallengeTimer();
    disableAllLetters();
    stopBirds();
    state.slots.forEach((slot, idx) => {
      const ch = state.wordChars[idx];
      if (ch === ' ') return;
      slot.textContent = ch;
      slot.style.color = '#c73737';
    });
    const t = TRANSLATIONS[state.lang];
    const elapsedTime = getElapsedTime();
    modalTitle.textContent = t.timeUp;
    modalDesc.textContent = t.wordWas + state.wordRaw + (elapsedTime > 0 ? `\n${t.timeElapsed}${elapsedTime} ${t.seconds}` : '');
    modalMedia.innerHTML = `<img src="${settings.images.crowdFail}" alt="time up" onerror="this.style.display='none'">`;
    modal.classList.add('show');
    lastReport = createReport('time_up');
    
    // üî• ÿßŸÑÿ•ÿµŸÑÿßÿ≠: ŸÖŸÜÿπ ÿ™ŸÉÿ±ÿßÿ± ÿµŸàÿ™ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑŸàŸÇÿ™
    if(!state.gameEndSoundPlayed && settings.sounds.failMessage) {
      playAudio(settings.sounds.failMessage, 0.22);
      state.gameEndSoundPlayed = true; // Ÿàÿ∂ÿπ ÿπŸÑÿßŸÖÿ© ÿ£ŸÜ ÿßŸÑÿµŸàÿ™ ÿ™ŸÖ ÿ™ÿ¥ÿ∫ŸäŸÑŸá
    }
  }

  // build game board
  function buildGameBoard(){
    endChallengeTimer();
    treeApples.innerHTML=''; fallenColumns.innerHTML=''; slotsRow.innerHTML=''; alphabetDiv.innerHTML='';
    state.apples=[]; state.slots=[]; state.alphabetButtons=[]; state.fallenCount=0;
    state.firstGuessTime = 0; // üî• ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ŸàŸÇÿ™ ÿ£ŸàŸÑ ÿ™ÿÆŸÖŸäŸÜ
    state.gameStartTime = Date.now(); // üî• ÿ≠ŸÅÿ∏ ŸàŸÇÿ™ ÿ®ÿØÿ° ÿßŸÑŸÑÿπÿ®ÿ©
    
    const n = state.maxApples;
    let appleSize = settings.options.appleSizeBasePx;
    if(n>12) appleSize = Math.max(30, appleSize - 6);
    if(n>20) appleSize = Math.max(24, appleSize - 10);
    const cols = Math.min(6, Math.ceil(Math.sqrt(n)));
    const rows = Math.ceil(n/cols);
    let idx=0;
    const treeWidthPercent = 85;
    const offsetPercent = (100-treeWidthPercent)/2;
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        if(idx>=n) break;
        const left = 4 + (c + (r%2?0.16:0)) * (62/cols) + (Math.random()*4 -2);
        const top = 10 + r * (70/rows) + (Math.random()*6 -3);
        const wrap = document.createElement('div'); wrap.className='apple-item';
        wrap.style.left = `calc(${left}% + ${offsetPercent/2}%)`; wrap.style.top = top + '%';
        wrap.dataset.index = idx; wrap.dataset.fallen = 'false';
        const img = document.createElement('img'); img.src = settings.images.apple; img.style.width = appleSize + 'px';
        wrap.appendChild(img); treeApples.appendChild(wrap); state.apples.push(wrap); idx++;
      }
    }
    renderSlots();
    renderAlphabet();
    
    // üî• ÿ™ÿ≠ÿ¨ŸäŸÖ ÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÑŸÑÿ¥ÿÆÿ∑ÿßÿ™ ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿ∑ŸàŸÑ ÿßŸÑŸÉŸÑŸÖÿ©
    const wordLength = state.wordChars.filter(ch=>ch!==' ').length;
    let slotFontSize = settings.options.slotFontSizePx;
    let slotGap = settings.options.slotUnderscoreSpacing;
    
    if (wordLength > 20) {
        slotFontSize = Math.max(16, slotFontSize - 8);
        slotGap = Math.max(4, slotGap - 6);
    } else if (wordLength > 15) {
        slotFontSize = Math.max(18, slotFontSize - 6);
        slotGap = Math.max(6, slotGap - 4);
    } else if (wordLength > 10) {
        slotFontSize = Math.max(22, slotFontSize - 4);
        slotGap = Math.max(8, slotGap - 2);
    }
    
    document.documentElement.style.setProperty('--slot-font', slotFontSize + 'px');
    document.documentElement.style.setProperty('--slot-gap', slotGap + 'px');
    
    updateDynamicElements();
  }

  function renderSlots(){
    slotsRow.innerHTML=''; state.slots=[];
    state.wordChars.forEach((ch,i)=>{
      const s=document.createElement('div'); s.className='slot'; s.dataset.pos=i;
      if(ch===' '){ s.classList.add('space'); s.textContent=' '; } else s.textContent='_';
      slotsRow.appendChild(s); state.slots.push(s);
    });
    const wordLength = state.wordChars.filter(ch=>ch!==' ').length;
    slotsRow.classList.remove('short-word','medium-word','long-word','very-long-word','extremely-long-word');
    if(wordLength<=8) slotsRow.classList.add('short-word');
    else if(wordLength<=16) slotsRow.classList.add('medium-word');
    else if(wordLength<=24) slotsRow.classList.add('long-word');
    else if(wordLength<=30) slotsRow.classList.add('very-long-word');
    else slotsRow.classList.add('extremely-long-word');
  }

  function renderAlphabet(){
    alphabetDiv.innerHTML=''; state.alphabetButtons=[];
    const arr = ALPHABETS[state.lang] || ALPHABETS.nl;
    const letters = (state.lang==='ar') ? arr.slice().reverse() : arr.slice();
    letters.forEach(l=>{
      const btn=document.createElement('button'); btn.className='letter-btn'; btn.textContent=l; btn.dataset.letter=l;
      btn.addEventListener('click', onLetterClick); alphabetDiv.appendChild(btn); state.alphabetButtons.push(btn);
    });
    alphabetDiv.style.direction = (state.lang==='ar') ? 'rtl' : 'ltr';
    adjustAlphabetButtons();
  }

  function adjustAlphabetButtons(){
    const isPortrait = window.matchMedia("(orientation: portrait)").matches;
    if(state.alphabetButtons && state.alphabetButtons.length){
      state.alphabetButtons.forEach(btn=>{
        if(isPortrait){
          btn.style.minWidth="32px"; btn.style.minHeight="32px"; btn.style.padding="8px 10px"; btn.style.fontSize="12px";
        } else {
          btn.style.minWidth="40px"; btn.style.minHeight="auto"; btn.style.padding="8px 10px"; btn.style.fontSize="inherit";
        }
      });
    }
  }

  function onLetterClick(e){
    const btn = e.currentTarget; 
    if(btn.classList.contains('disabled')) return;
    
    // üî• ÿ®ÿØÿ° ÿßŸÑŸÖÿ§ŸÇÿ™ ÿπŸÜÿØ ÿ£ŸàŸÑ ÿ™ÿÆŸÖŸäŸÜ ŸÅŸä ÿßŸÑÿ™ÿ≠ÿØŸä
    if (state.activeChallenge && !state.firstGuessTime) {
        state.firstGuessTime = Date.now();
        startTimerOnFirstGuess();
    }
    
    btn.classList.add('disabled'); 
    btn.disabled=true; 
    uiClick(); 
    const letter = btn.dataset.letter; 
    handleGuess(letter);
  }

  function handleGuess(letter){
    let match=false;
    state.wordChars.forEach(ch => {
      if(ch===' ') return;
      if(state.lang==='ar'){ if(ch===letter) match=true; } else { if(ch.toUpperCase()===letter.toUpperCase()) match=true; }
    });
    if(match){
      revealLetter(letter);
      const isLastLetter = checkIfLastLetter();
      if(!isLastLetter){ 
        const list=settings.sounds.successList||[]; 
        if(list.length) playAudio(list[state.successIndex%list.length],0.18); 
        state.successIndex++; 
      }
      checkWin();
    } else {
      triggerAppleFall(letter);
    }
  }

  function checkIfLastLetter(){
    let revealed=0;
    state.wordChars.forEach((ch,idx)=>{ if(ch!==' ' && state.slots[idx].textContent!=='_') revealed++; });
    return revealed >= state.maxApples;
  }

  function revealLetter(letter){
    state.wordChars.forEach((ch,idx)=>{ 
      if(ch===' ') return; 
      const equal = (state.lang==='ar') ? (ch===letter) : (ch.toUpperCase()===letter.toUpperCase()); 
      if(equal){ 
        state.slots[idx].textContent = ch; 
        state.slots[idx].style.color = '#0b8a3a'; 
        state.slots[idx].classList.add('revealed'); 
      }
    });
  }

  function triggerAppleFall(letter){
    const appleEl = state.apples.find(a=>a.dataset.fallen==='false'); 
    if(!appleEl) return;
    
    appleEl.dataset.fallen='true'; 
    appleEl.style.opacity='0.14'; 
    state.fallenCount++;
    
    const isLastApple = state.fallenCount >= state.maxApples;
    const rect = appleEl.getBoundingClientRect();
    const clone = appleEl.cloneNode(true);
    clone.style.position='fixed'; 
    clone.style.left=(rect.left + rect.width/2) + 'px'; 
    clone.style.top=(rect.top + rect.height/2) + 'px';
    clone.style.transform='translate(-50%,-50%) scale(1)'; 
    clone.style.zIndex=9999; 
    document.body.appendChild(clone);
    
    const perCol = settings.options.maxApplesPerColumn || 3;
    const colIndex = Math.floor((state.fallenCount - 1) / perCol);
    let colEl = fallenColumns.querySelector(`.fallen-column[data-col='${colIndex}']`);
    if(!colEl){ 
      colEl = document.createElement('div'); 
      colEl.className='fallen-column'; 
      colEl.dataset.col = colIndex; 
      fallenColumns.appendChild(colEl); 
    }
    
    const temp = document.createElement('div'); 
    temp.style.width='1px'; 
    temp.style.height='1px'; 
    temp.style.opacity='0'; 
    colEl.appendChild(temp);
    
    const targetRect = temp.getBoundingClientRect();
    if(!isLastApple && state.audioEnabled) playAudio(settings.sounds.fallWhistle, 0.16);
    
    const fallDur = settings.options.fallDurationMs || 700;
    const bounceDur = settings.options.bounceDurationMs || 420;
    const tilt = settings.options.bounceTiltDeg || 28;
    
    requestAnimationFrame(()=>{ 
      clone.style.transition = `top ${fallDur}ms cubic-bezier(.2,.9,.2,1)`; 
      clone.style.top = (targetRect.top - 28) + 'px'; 
    });
    
    setTimeout(()=>{
      if(!isLastApple && state.audioEnabled) playAudio(settings.sounds.impact, 0.16);
      const tx = targetRect.left + (targetRect.width/2);
      const ty = targetRect.top + (targetRect.height/2);
      clone.style.transition = `left ${bounceDur}ms cubic-bezier(.2,.9,.2,1), top ${bounceDur}ms cubic-bezier(.2,.9,.2,1), transform ${bounceDur}ms ease`;
      clone.style.left = tx + 'px';
      clone.style.top = ty + 'px';
      clone.style.transform = `translate(-50%,-50%) scale(0.92) rotate(${tilt}deg)`;
      if(!isLastApple && state.audioEnabled && settings.sounds.slide) playAudio(settings.sounds.slide, 0.12);
    }, fallDur + 20);
    
    setTimeout(()=>{
      if(clone && clone.parentNode) clone.parentNode.removeChild(clone);
      const item = document.createElement('div'); 
      item.className='fallen-item';
      const imgWrap = document.createElement('div'); 
      imgWrap.innerHTML = appleEl.innerHTML; 
      imgWrap.querySelector('img').style.width='44px';
      const letterEl = document.createElement('div'); 
      letterEl.className='fallen-letter'; 
      letterEl.textContent = letter;
      item.appendChild(imgWrap); 
      item.appendChild(letterEl); 
      colEl.appendChild(item);
      
      if(temp && temp.parentNode) temp.parentNode.removeChild(temp);
      
      if(!isLastApple){ 
        playFailSound();
      }
      checkLose();
    }, fallDur + bounceDur + 60);
  }

  // üî• ÿßŸÑÿ•ÿµŸÑÿßÿ≠ ÿßŸÑŸÜŸáÿßÿ¶Ÿä: ÿ™ÿπÿØŸäŸÑ ÿØÿßŸÑÿ© checkWin
  function checkWin(){
    const unfinished = state.slots.some(s => s.textContent === '_');
    if(!unfinished){
      endChallengeTimer();
      disableAllLetters();
      stopBirds();
      state.slots.forEach(s=>{ if(s.textContent !== ' ') s.style.color = '#0b8a3a'; });
      const t = TRANSLATIONS[state.lang];
      const elapsedTime = getElapsedTime();
      modalTitle.textContent = t.congrats;
      modalDesc.textContent = t.guessedWord + (elapsedTime > 0 ? `\n${t.timeElapsed}${elapsedTime} ${t.seconds}` : '');
      modalMedia.innerHTML = `<img src="${settings.images.crowdWin}" alt="win" onerror="this.style.display='none'">`;
      modal.classList.add('show');
      lastReport = createReport('win');
      
      // üî• ÿßŸÑÿ•ÿµŸÑÿßÿ≠: ŸÖŸÜÿπ ÿ™ŸÉÿ±ÿßÿ± ÿµŸàÿ™ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑŸÜÿ¨ÿßÿ≠ ÿßŸÑŸÜŸáÿßÿ¶Ÿäÿ©
      if(!state.gameEndSoundPlayed && settings.sounds.successMessage) {
        playAudio(settings.sounds.successMessage, 0.22);
        state.gameEndSoundPlayed = true; // Ÿàÿ∂ÿπ ÿπŸÑÿßŸÖÿ© ÿ£ŸÜ ÿßŸÑÿµŸàÿ™ ÿ™ŸÖ ÿ™ÿ¥ÿ∫ŸäŸÑŸá
      }
    }
  }

  // üî• ÿßŸÑÿ•ÿµŸÑÿßÿ≠ ÿßŸÑŸÜŸáÿßÿ¶Ÿä: ÿ™ÿπÿØŸäŸÑ ÿØÿßŸÑÿ© checkLose
  function checkLose(){
    if(state.fallenCount >= state.maxApples){
      endChallengeTimer();
      disableAllLetters();
      stopBirds();
      state.slots.forEach((slot,idx)=>{ 
        const ch=state.wordChars[idx]; 
        if(ch===' ') return; 
        slot.textContent = ch; 
        slot.style.color = '#c73737'; 
      });
      const t = TRANSLATIONS[state.lang];
      const elapsedTime = getElapsedTime();
      modalTitle.textContent = t.applesFinished;
      modalDesc.textContent = t.wordWas + state.wordRaw + (elapsedTime > 0 ? `\n${t.timeElapsed}${elapsedTime} ${t.seconds}` : '');
      modalMedia.innerHTML = `<img src="${settings.images.crowdFail}" alt="fail" onerror="this.style.display='none'">`;
      modal.classList.add('show');
      lastReport = createReport('lose');
      
      // üî• ÿßŸÑÿ•ÿµŸÑÿßÿ≠: ŸÖŸÜÿπ ÿ™ŸÉÿ±ÿßÿ± ÿµŸàÿ™ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑŸÅÿ¥ŸÑ ÿßŸÑŸÜŸáÿßÿ¶Ÿäÿ©
      if(!state.gameEndSoundPlayed && settings.sounds.failMessage) {
        playAudio(settings.sounds.failMessage, 0.22);
        state.gameEndSoundPlayed = true; // Ÿàÿ∂ÿπ ÿπŸÑÿßŸÖÿ© ÿ£ŸÜ ÿßŸÑÿµŸàÿ™ ÿ™ŸÖ ÿ™ÿ¥ÿ∫ŸäŸÑŸá
      }
    }
  }

  // üî• ÿßŸÑÿ•ÿµŸÑÿßÿ≠ ÿßŸÑŸÜŸáÿßÿ¶Ÿä: ÿ™ÿπÿØŸäŸÑ ÿ≠ÿØÿ´ startBtn
  startBtn.addEventListener('click', async ()=>{
    uiClick();
    const raw = (wordInput.value || '').trim();
    const t = TRANSLATIONS[state.lang];
    if(!raw){ alert(t.enterWord); return; }
    passwordDots.style.display = 'none';
    const word = state.lang==='ar' ? raw : raw.toUpperCase();
    state.wordRaw = word;
    state.wordChars = word.split('');
    state.maxApples = word.replace(/\s/g,'').length;
    
    // üî• ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿπŸÑÿßŸÖÿ© ÿßŸÑÿµŸàÿ™ ÿßŸÑŸÜŸáÿßÿ¶Ÿä
    state.gameEndSoundPlayed = false;
    state.firstGuessTime = 0; // üî• ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ŸàŸÇÿ™ ÿ£ŸàŸÑ ÿ™ÿÆŸÖŸäŸÜ
    
    pageSetup.classList.remove('active'); 
    pageGame.classList.add('active');
    buildGameBoard();
  });

  // ÿ≤ÿ± ÿßŸÑÿ™ÿ≠ÿØŸä ŸÅŸä ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ£ŸàŸÑŸâ
  challengeBtn.addEventListener('click', ()=>{
    uiClick();
    const raw = (wordInput.value || '').trim();
    const t = TRANSLATIONS[state.lang];
    if(!raw){ 
        alert(t.typeChallengeWord); 
        return; 
    }
    challengeInputContainer.style.display = 'flex';
  });

  // ÿ≤ÿ± ÿßŸÑÿ™ÿ≠ÿØŸä ŸÅŸä ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ´ÿßŸÜŸäÿ©
  challengeBtnGame.addEventListener('click', ()=>{
    uiClick();
    const raw = state.wordRaw; // ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÉŸÑŸÖÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© ŸÖŸÜ ÿßŸÑŸÑÿπÿ®ÿ©
    const t = TRANSLATIONS[state.lang];
    if(!raw){ 
        alert(t.typeChallengeWord); 
        return; 
    }
    challengeInputContainer.style.display = 'flex';
  });

  confirmChallengeBtn.addEventListener('click', ()=>{
    uiClick();
    const duration = parseInt(challengeDurationInput.value);
    if(!duration || duration < 10 || duration > 300){
        alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸàŸÇÿ™ ÿ®ŸäŸÜ 10 Ÿà 300 ÿ´ÿßŸÜŸäÿ©');
        return;
    }
    
    const raw = (wordInput.value || state.wordRaw || '').trim(); // ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÉŸÑŸÖÿ© ŸÖŸÜ ÿ£Ÿä ÿµŸÅÿ≠ÿ©
    const link = generateChallengeLink({ 
        word: (state.lang==='ar' ? raw : raw.toUpperCase()), 
        durationSec: duration 
    });
    
    challengeInputContainer.style.display = 'none';
    challengeDurationInput.value = '';
    
    if(navigator.share){
        const challengeText = TRANSLATIONS[state.lang].challengeText.replace('{seconds}', duration);
        navigator.share({ 
            title: 'AppelBoom Challenge', 
            text: challengeText, 
            url: link 
        }).catch(()=>{});
    } else {
        prompt(TRANSLATIONS[state.lang].copyLink, link);
    }
  });

  document.addEventListener('click', (e) => {
    if (challengeInputContainer.style.display === 'flex' && 
        !challengeInputContainer.contains(e.target) && 
        e.target !== challengeBtn && 
        e.target !== challengeBtnGame) {
        challengeInputContainer.style.display = 'none';
        challengeDurationInput.value = '';
    }
  });

  // üî• ÿßŸÑÿ•ÿµŸÑÿßÿ≠ ÿßŸÑŸÜŸáÿßÿ¶Ÿä: ÿ™ÿπÿØŸäŸÑ ÿ≠ÿØÿ´ newBtn
  newBtn.addEventListener('click', ()=>{
    uiClick();
    endChallengeTimer();
    state.activeChallenge = null;
    state.firstGuessTime = 0; // üî• ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ŸàŸÇÿ™ ÿ£ŸàŸÑ ÿ™ÿÆŸÖŸäŸÜ
    
    pageGame.classList.remove('active'); 
    pageSetup.classList.add('active');
    wordInput.value = '';
    passwordDots.style.display = 'none';
    treeApples.innerHTML=''; fallenColumns.innerHTML=''; slotsRow.innerHTML=''; alphabetDiv.innerHTML='';
    state.wordRaw=''; state.wordChars=[]; state.maxApples=0; state.apples=[]; state.fallenCount=0; state.slots=[];
    state.lastFailSoundTime = 0;
    state.gameEndSoundPlayed = false;
    
    setTimeout(()=>{ 
        document.addEventListener('click', function restartBirds(){ 
            if(state.audioEnabled && pageSetup.classList.contains('active')){ 
                playBirds(); 
                document.removeEventListener('click', restartBirds); 
            } 
        }); 
    }, 100);
  });

  // üî• ÿßŸÑÿ•ÿµŸÑÿßÿ≠ ÿßŸÑŸÜŸáÿßÿ¶Ÿä: keyboard support - ÿ•ÿµŸÑÿßÿ≠ ŸÖÿ¥ŸÉŸÑÿ© Enter
  document.addEventListener('keydown', function(e){
    // ÿßŸÑÿ™ÿπÿßŸÖŸÑ ŸÖÿπ ÿµŸÅÿ≠ÿ© ÿßŸÑÿ•ÿπÿØÿßÿØ Ÿàÿ≤ÿ± Enter
    if(pageSetup.classList.contains('active') && e.key === 'Enter') {
        e.preventDefault(); // ŸÖŸÜÿπ ÿßŸÑÿ≥ŸÑŸàŸÉ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä ÿ™ŸÖÿßŸÖÿßŸã
        e.stopPropagation(); // ŸÖŸÜÿπ ÿßŸÜÿ™ÿ¥ÿßÿ± ÿßŸÑÿ≠ÿØÿ´
        setTimeout(() => {
            startBtn.click(); // ÿ™ŸÅÿπŸäŸÑ ÿ≤ÿ± Start
        }, 10);
        return;
    }
    
    if(!pageGame.classList.contains('active')) return;
    
    const key = e.key.toUpperCase();
    const arr = ALPHABETS[state.lang] || ALPHABETS.nl;
    const isValid = arr.includes(key) || (state.lang==='ar' && arr.includes(e.key));
    if(isValid){
        const letterBtn = Array.from(state.alphabetButtons).find(btn=> btn.dataset.letter === key || (state.lang==='ar' && btn.dataset.letter === e.key) );
        if(letterBtn && !letterBtn.classList.contains('disabled')) {
            // üî• ÿ®ÿØÿ° ÿßŸÑŸÖÿ§ŸÇÿ™ ÿπŸÜÿØ ÿ£ŸàŸÑ ÿ™ÿÆŸÖŸäŸÜ ŸÅŸä ÿßŸÑÿ™ÿ≠ÿØŸä
            if (state.activeChallenge && !state.firstGuessTime) {
                state.firstGuessTime = Date.now();
                startTimerOnFirstGuess();
            }
            letterBtn.click();
        }
    }
    if(e.key === 'Enter' && pageGame.classList.contains('active')) newBtn.click();
  });

  modalOk.addEventListener('click', ()=>{ uiClick(); modal.classList.remove('show'); });

  function generateChallengeLink({ word, durationSec = 60, mode = 'solo' }){
    const payload = { 
        id: 'c-' + Date.now(), 
        word, 
        durationSec, 
        mode, 
        ts: Date.now(),
        lang: state.lang // üî• ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÑÿ∫ÿ© ÿ•ŸÑŸâ payload
    };
    const b64 = btoa(encodeURIComponent(JSON.stringify(payload)));
    const url = new URL(location.href);
    url.searchParams.set('challenge', b64);
    return url.toString();
  }

  function parseChallengeFromUrl(){
    const p = new URL(location.href).searchParams.get('challenge');
    if(!p) return null;
    try{
      const json = decodeURIComponent(atob(p));
      return JSON.parse(json);
    }catch(e){ console.warn('bad challenge url', e); return null; }
  }

  function handleIncomingChallenge(){
    const ch = parseChallengeFromUrl();
    if(!ch) return;
    
    const spectate = new URL(location.href).searchParams.get('spectate');
    if(spectate === '1'){
      pageSetup.classList.remove('active'); pageGame.classList.add('active');
      state.wordRaw = ch.word; state.wordChars = ch.word.split(''); state.maxApples = ch.word.replace(/\s/g,'').length;
      buildGameBoard();
      state.alphabetButtons.forEach(b=>{ b.disabled=true; b.classList.add('disabled'); });
      modalTitle.textContent = 'Spectator Mode'; modalDesc.textContent = `Viewing challenge: ${ch.id}`; modalMedia.innerHTML='';
      modal.classList.add('show');
      return;
    }
    
    // üî• ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ localStorage ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ™ÿ≠ÿØŸä ÿ™ŸÖ ÿ™ÿ¥ÿ∫ŸäŸÑŸá ŸÖÿ≥ÿ®ŸÇÿßŸã ÿπŸÑŸâ Ÿáÿ∞ÿß ÿßŸÑÿ¨Ÿáÿßÿ≤
    const playedChallenges = JSON.parse(localStorage.getItem('playedChallenges') || '{}');
    if (playedChallenges[ch.id]) {
        // üî• ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÑÿ∫ÿ© ÿßŸÑÿ™ÿ≠ÿØŸä ÿßŸÑÿ£ÿµŸÑŸäÿ© (ŸÖŸÜ localStorage ÿ£Ÿà ŸÖŸÜ payload)
        const challengeLang = playedChallenges[ch.id].lang || ch.lang || state.lang;
        const t = TRANSLATIONS[challengeLang];
        
        // üî• ÿπÿ±ÿ∂ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ÿØÿßÿÆŸÑ modal ÿßŸÑŸÑÿπÿ®ÿ©
        modalTitle.textContent = t.challengeUsed;
        modalDesc.textContent = t.challengeUsedDesc;
        modalMedia.innerHTML = `<img src="${settings.images.crowdFail}" alt="challenge used">`;
        modal.classList.add('show');
        return;
    }
    
    const t = TRANSLATIONS[state.lang];
    const accept = confirm(t.acceptChallenge + `\n${ch.word ? t.wordLength + (ch.word.replace(/\s/g,'').length) : ''}`);
    if(accept){
        // üî• ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ≠ÿØŸä ŸÅŸä localStorage ŸÖÿπ ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©
        playedChallenges[ch.id] = {
            playedAt: Date.now(),
            word: ch.word,
            duration: ch.durationSec,
            lang: state.lang // üî• ÿ≠ŸÅÿ∏ ŸÑÿ∫ÿ© ÿßŸÑÿ™ÿ≠ÿØŸä
        };
        localStorage.setItem('playedChallenges', JSON.stringify(playedChallenges));
        
        pageSetup.classList.remove('active'); 
        pageGame.classList.add('active');
        state.wordRaw = ch.word; 
        state.wordChars = ch.word.split(''); 
        state.maxApples = ch.word.replace(/\s/g,'').length;
        state.activeChallenge = ch;
        state.firstGuessTime = 0; // üî• ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ŸàŸÇÿ™ ÿ£ŸàŸÑ ÿ™ÿÆŸÖŸäŸÜ
        buildGameBoard();
        startChallengeTimer(ch.durationSec);
    }
  }

  let lastReport = null;

  function createReport(result){
    const now = Date.now();
    const elapsedTime = getElapsedTime();
    const report = {
      id: 'r-' + now,
      ts: now,
      result,
      word: state.wordRaw,
      fallen: state.fallenCount,
      maxApples: state.maxApples,
      lang: state.lang, // üî• ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÑÿ∫ÿ© ÿßŸÑŸÑÿπÿ®ÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©
      playerAgent: navigator.userAgent,
      elapsedTime: elapsedTime, // üî• ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿ∫ÿ±ŸÇ
      challengeId: state.activeChallenge?.id || null
    };
    computeReportSignature(report).then(sig=>{ report.signature = sig; });
    return report;
  }

  async function computeReportSignature(report){
    try{
      const json = JSON.stringify(report);
      const data = new TextEncoder().encode(json + '|' + (settings.reportSalt || ''));
      const hash = await crypto.subtle.digest('SHA-256', data);
      const arr = Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
      return arr;
    }catch(e){ console.warn('signature error', e); return ''; }
  }

  async function renderReportImage(report){
    const w = 720, h = 480;
    const c = document.createElement('canvas'); c.width = w; c.height = h;
    const ctx = c.getContext('2d');
    ctx.fillStyle = '#0b5138'; ctx.fillRect(0,0,w,h);
    
    // üî• ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÑÿ∫ÿ© ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿ©
    const t = TRANSLATIONS[report.lang] || TRANSLATIONS.en;
    
    ctx.fillStyle = '#fff'; ctx.font = '20px Inter, Arial'; ctx.fillText('AppelBoom - Report', 20, 40);
    ctx.font = '16px Inter, Arial';
    ctx.fillText(`${t.wordWas} ${report.word}`, 20, 80);
    ctx.fillText(`Result: ${report.result}`, 20, 110);
    ctx.fillText(`Fallen apples: ${report.fallen} / ${report.maxApples}`, 20, 140);
    ctx.fillText(`Language: ${report.lang}`, 20, 170);
    ctx.fillText(`Time: ${new Date(report.ts).toLocaleString()}`, 20, 200);
    
    // üî• ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿ∫ÿ±ŸÇ
    if (report.elapsedTime > 0) {
        ctx.fillText(`${t.timeElapsed} ${report.elapsedTime} ${t.seconds}`, 20, 230);
        ctx.fillText(`Signature(sha256): ${report.signature ? report.signature.slice(0,24) + '...' : 'pending'}`, 20, 260);
    } else {
        ctx.fillText(`Signature(sha256): ${report.signature ? report.signature.slice(0,24) + '...' : 'pending'}`, 20, 230);
    }
    
    const apples = report.maxApples || 0;
    const fallen = report.fallen || 0;
    const cols = Math.min(10, apples);
    const rows = Math.ceil(apples / cols);
    const baseX = 20, baseY = report.elapsedTime > 0 ? 290 : 260, gap = 28;
    let k = 0;
    for(let r=0;r<rows;r++){
      for(let c0=0;c0<cols;c0++){
        if(k>=apples) break;
        const x = baseX + c0*gap; const y = baseY + r*gap;
        ctx.beginPath(); ctx.arc(x,y,10,0,Math.PI*2);
        ctx.fillStyle = (k < fallen) ? '#c73737' : '#ffffff';
        ctx.fill(); ctx.strokeStyle='#00000033'; ctx.stroke();
        k++;
      }
    }
    return c.toDataURL('image/png');
  }

  async function shareReport(){
    const t = TRANSLATIONS[state.lang];
    if(!lastReport){ alert(t.noReport); return; }
    lastReport.signature = lastReport.signature || await computeReportSignature(lastReport);
    const dataUrl = await renderReportImage(lastReport);
    const res = await fetch(dataUrl); const blob = await res.blob();
    const filesArray = [ new File([blob], `${lastReport.id}.png`, { type: blob.type }) ];
    if(navigator.canShare && navigator.canShare({ files: filesArray })){
      try{ await navigator.share({ files: filesArray, title: 'AppelBoom Report', text: JSON.stringify(lastReport) }); return; }catch(e){ console.warn('share failed', e); }
    }
    const w = window.open('', '_blank');
    if(w){ w.document.write(`<img src="${dataUrl}" style="max-width:100%"><pre>${JSON.stringify(lastReport,null,2)}</pre>`); }
    try{ await navigator.clipboard.writeText(JSON.stringify(lastReport)); alert(t.reportCopied); }catch(e){}
  }

  shareReportBtn.addEventListener('click', shareReport);

  function updateDynamicElements(){
    adjustAlphabetButtons();
    const isPortrait = window.matchMedia("(orientation: portrait)").matches;
    const cols = fallenColumns.querySelectorAll('.fallen-column');
    cols.forEach(c=>{ c.style.width = isPortrait ? '70px' : '84px'; });
  }

  handleIncomingChallenge();

  document.addEventListener('click', function first(){ if(state.audioEnabled) playBirds(); document.removeEventListener('click', first); });
  soundToggle.addEventListener('click', ()=>{ state.audioEnabled = !state.audioEnabled; if(state.audioEnabled){ soundToggle.classList.remove('muted'); soundToggle.setAttribute('aria-label','ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿµŸàÿ™'); playBirds(); } else { soundToggle.classList.add('muted'); soundToggle.setAttribute('aria-label','ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿµŸàÿ™'); stopBirds(); } uiClick(); });

  window.Appelboom = { settings, state, generateChallengeLink, parseChallengeFromUrl, createReport, computeReportSignature };
})();</script>